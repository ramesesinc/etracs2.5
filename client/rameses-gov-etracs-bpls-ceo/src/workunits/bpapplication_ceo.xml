<workunit>
    <invokers>
        <invoker type="bpapplication_ceo:open" action="open" target="window"/>
        <invoker type="formActions" caption="Close" action="_close" />
        
        <invoker type="formActions" caption="Submit" action="submit" visibleWhen="#{submitted==false}"/>
         <invoker type="infoActions" caption="Add Fee" action="addFee" visibleWhen="#{submitted==false}"/>
    </invokers>
    
    <code>
        <![CDATA[    
        import com.rameses.rcp.annotations.*
        import com.rameses.rcp.common.*
        import com.rameses.osiris2.client.*
        import com.rameses.osiris2.common.*
        import java.rmi.server.*;
        import com.rameses.gov.etracs.bpls.application.*;
        
        class BPApplicationCEOController  {
            
            @Service("CityEngineerBPApplicationService")
            def appSvc;
        
            @Binding
            def binding;
            
            @FormId
            def windowId;
            
            @FormTitle
            def windowTitle;
            
            String title = "Business Application ";
            def deptList = LOV.BUSINESS_EXT_DEPT;
            def entity;
            def department;
            def refid;
            def reftype;
            def taxfees = [];
            def total = 0;
            def submitted = false;
            
            void open() {
                department = entity.department;
                refid = entity.refid;
                reftype = entity.reftype;
                if( entity.completed == 1 ) submitted = true;
                entity = appSvc.open( entity );
                title = title + "-" + entity.appno + " (" + deptList.find{ it.key ==  department }?.value + ")";
                windowTitle = entity.appno;
                windowId = entity.objid;
                //taxfees = entity.taxfees.findAll{ it.department == department }
                //total = taxfees.sum{it.amount};
            }
            
          
            def sortInfos(sinfos) {
                return sinfos.findAll{it.lob?.objid==null} + sinfos.findAll{ it.lob?.objid!=null }.sort{ it.lob.name };
            }
    
            def infoModel = [
                fetchList: { o-> return sortInfos(entity.infos); }
            ] as BasicListModel;
    
            //show only fees related to department
            def taxfeeModel = [
                fetchList: { o-> return taxfees;  },
                onRemoveItem: { o->
                    if(submitted) return false;
                    if(MsgBox.confirm("Remove this entry?")) {
                        appSvc.removeExternalFee(o);
                        total = taxfees.sum{ it.amount };
                        binding.refresh("total");
                        taxfeeModel.reload();
                        return true;
                    }
                    return  false;
                }
            ] as EditorListModel;
         
            def addFee() {
                return InvokerUtil.lookupOpener("bpapplication_extoffice:addfee", [
                    department: department,
                    refid: refid,
                    reftype: reftype,
                    handler: { o->
                        if( taxfees.find{it.account.objid==o.account.objid} )
                            throw new Exception("Account already added");
                        o.objid = "BPTAXFEE" + new UID();
                        o.applicationid = entity.objid;
                        o.businessid = entity.businessid;
                        o.iyear = entity.appyear;
                        appSvc.addExternalFee( o );
                        taxfees << o;
                        total = taxfees.sum{ it.amount };
                        taxfeeModel.reload();
                        binding.refresh("total");
                    }
                ]);
            }
            
            void submit() {
                if(MsgBox.confirm( "You are about to submit this transaction. Please ensure all fees are correct" )) {
                    entity.refid = refid;
                    entity.department = department;
                    appSvc.submitExternalFees(entity);
                    MsgBox.alert("submit succeeded");
                    submitted = true;
                }
            }
            
        }
        ]]>
        
    </code>
   
    <pages>
        <page name="confirm-save" template="com.rameses.gov.etracs.bpls.ceo.ApplicationInfoPage"/>
    </pages>
    
</workunit>