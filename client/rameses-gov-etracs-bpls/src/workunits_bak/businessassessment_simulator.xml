<workunit >
    <invokers>
        <invoker folderid="/menu/txn/bpls" caption="BP Assessment Simulator" target="window" index="10" />
    </invokers>
    
    <code>
        <![CDATA[
        import com.rameses.rcp.common.*;
        import com.rameses.rcp.annotations.*;
        import com.rameses.osiris2.client.*;
        import com.rameses.osiris2.common.*
        import java.rmi.server.*;
        
        class BusinessAssessmentSimulator  {
            
            @Service("BusinessAssessmentService")
            def assessmentSvc;

            def orgTypes = LOV.BUSINESS_ORG_TYPES;
            def officeTypes = LOV.BUSINESS_OFFICE_TYPES;
            def appTypes = LOV.BUSINESS_APP_TYPES;
            
            def entity = [lobs:[],infos:[],taxfees:[]];
            def formInfos;
            
            def getLookupLOB() {
                return InvokerUtil.lookupOpener("lob:lookup",[
                    onselect: { o->
                        if( entity.lobs.find{ it.lobid ==  o.objid }!=null ) {
                            throw new Exception("LOB Item already added");
                        }    
                        def m = [:];    
                        m.objid = "APPLOB"+new UID();
                        m.lobid = o.objid;
                        m.name = o.name;
                        entity.lobs << m;
                        lobModel.reload();
                    }
                ]);
            }
            
            def lobModel = [
                fetchList: { o->return entity.lobs }
            ] as BasicListModel;
            
            def run() {
                entity = assessmentSvc.execute(entity);
                formInfos = [];
                entity.infos.each {x->
                    def i = [type:x.attribute.datatype, 
                        caption:x.attribute.caption, categoryid:x.lob.objid, name:x.attribute.name, bean: x  ];
                    if(i.datatype == "boolean") {
                        i.type = "checkbox";
                    }
                    formInfos << i;
                }
                return new Opener(outcome: "info", id:"businessassessment:simulator", target:"popup");
            }
            
            def formPanel = [
                getCategory: { lobid->
                    return entity.lobs.find{ it.lobid == lobid }?.name
                },
                updateBean: {name,value,item->
                    item.bean[item.attribute.datatype+"value"] = value;
                },
                getControlList: {
                    return formInfos;
                }
            ] as FormPanelModel;
            
            def infoModel = [
                fetchList: { o->
                    return entity.infos;
                }
            ] as BasicListModel;
            
            def doOk() {
                MsgBox.alert( entity );
                infoModel.reload();
                return "_close";
            }
            
            def doCancel() {
                return "_close";
            }
            
        }
        
        ]]>
    </code>
    
    <pages>
        <page template="com.rameses.gov.etracs.rules.bpls.BPAssessmentSimulatorPage" />
        <page name="info" template="com.rameses.gov.etracs.rules.bpls.InfoPage" />
    </pages>
    
    
</workunit>