<workunit>
    <invokers>
        <invoker type="rulecondition:lobinfo:create" action="create" target="popup"/>
        <invoker type="rulecondition:lobinfo:open" action="open"  target="popup"/>
    </invokers>
    <code>
        <![CDATA[
            import com.rameses.rcp.common.*
            import com.rameses.rcp.annotations.*
            import com.rameses.osiris2.client.*
            import com.rameses.osiris2.common.*
            import com.rameses.rulemgmt.constraint.*;
            import com.rameses.rulemgmt.*;
            import java.rmi.server.*;
            
            class RuleConditionLOBInfoController extends RuleConditionController {
            
                def lobList;
                def var;
                def lob = [:];
                def varname;
                
                void buildLobList() {
                    lobList = service.findAllVarsByType( 
                        [ruleid:rule.objid, datatype:'lob', pos: entity.pos ] ).collect{  
                        [objid: it.objid, name: it.name]
                    };
                }
                
                void create() {
                    super.create();
                    buildLobList();
                }
                
                void open() {
                    super.open();
                    buildLobList();
                }
                
                def getLookupVar() {
                    return InvokerUtil.lookupOpener("businessvariable:lookup",[
                        onselect: { o->
                            varname = o.name;
                            var = o;
                            binding.refresh("varname");
                        }
                    ]);
                }
                
                def doOk() {
                    if(mode=="create") {
                        entity.constraints.clear();
                        def c = [:]
                        c.objid = "RCONST"+new UID();
                        c.parentid = entity.objid;
                        c.pos = 0;
                        c.stringvalue == var.objid;
                        c.field = [objid: 'bpassessment-lobinfo-varid' ];
                        c.operator = [caption:'equals', symbol:'==' ];
                        entity.constraints << c;
                        
                        entity.vars.clear();
                        def v = [:];
                        v.objid = "RULVAR"+new UID();
                        v.pos = 0;
                        v.parentid = entity.objid;
                        v.datatype = var.datatype;
                        v.varname = varname;
                        v.refname = v.datatype + "value";
                        entity.vars << v;
                        
                        rule.conditions << entity;
                    }    
                    service.saveCondition(entity);
                    savehandler(rule);
                    return "_exit";
                }    

                def doCancel() {
                    return "_exit";
                }    
            }
        ]]>
        
    </code>
    <pages>
        <page template="com.rameses.gov.etracs.rules.bpls.BusinessVariable"/>
    </pages>
</workunit>
