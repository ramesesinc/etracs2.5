<workunit>
    <invokers>
        <invoker type="bpapplication:open" caption="BP Application" action="startOpen" target="window"  role="BUSINESSINFO,LICENSING"/>
        <invoker type="bpapplication:openByAppno" caption="BP Application" action="startOpenByAppno" target="window" role="BUSINESSINFO,LICENSING"/>
        <invoker type="global:barcode:51005" caption="BP Application" action="startOpenByAppno" target="window"  srole="BUSINESSINFO,LICENSING"/>
        
        
        <!-- For Business Info -->
        <invoker type="infoActions" caption="Update App Info" action="updateAppInfo" visibleWhen="#{entity.state == 'info'}" role="BUSINESSINFO"/>
        <invoker type="infoActions" caption="Update LOB" action="updateLOB" visibleWhen="#{entity.state=='info'}" role="BUSINESSINFO"/>
        <invoker type="infoActions" caption="Update Assessment Info" action="updateAssessmentInfo" visibleWhen="#{entity.state == 'info'}" role="BUSINESSINFO"/>
        <invoker type="infoActions" caption="Save" action="saveUpdate" visibleWhen="#{entity.state=='info'}" role="BUSINESSINFO"/>
                
        <!-- For Assessors -->
        <invoker type="infoActions" caption="Update LOB" action="updateLOB" visibleWhen="#{entity.state=='assessment'}" role="ASSESSOR"/>
        <invoker type="infoActions" caption="Update Assessment Info" action="updateAssessmentInfo" visibleWhen="#{entity.state == 'assessment'}" role="ASSESSOR"/>
        <invoker type="infoActions" caption="Calculate Tax Fees" action="calculateTaxfee" visibleWhen="#{entity.state=='assessment'}" role="ASSESSOR"/>
        <invoker type="infoActions" caption="View Previous Assessments" action="viewPrevAssessments" visibleWhen="#{entity.state=='assessment' &amp;&amp; entity.apptype=='RENEW'}" role="ASSESSOR"/>
        <invoker type="infoActions" caption="Save" action="saveUpdate" visibleWhen="#{entity.state=='assessment'}" role="ASSESSOR"/>

        <!-- For Approvers -->
        <invoker type="infoActions" caption="Update LOB" action="updateLOB" visibleWhen="#{entity.state == 'approval'}" role="APPROVER"/>
        <invoker type="infoActions" caption="Update Assessment Info" action="updateAssessmentInfo" visibleWhen="#{entity.state == 'approval'}" role="APPROVER"/>
        <invoker type="infoActions" caption="Calculate Tax Fees" action="calculateTaxfee" visibleWhen="#{entity.state=='approval'}" role="APPROVER"/>
        <invoker type="infoActions" caption="View Previous Assessments" action="viewPrevAssessments" visibleWhen="#{entity.state=='approval' &amp;&amp; entity.apptype=='RENEW'}" role="APPROVER"/>
        <invoker type="infoActions" caption="Save" action="saveUpdate" visibleWhen="#{entity.state=='approval'}" role="APPROVER"/>

        <invoker type="extActions" caption="Reports" name="popupReports"  visibleWhen="#{entity.state!='draft'}" category="bpapplication:report" />
            
        <!-- BUSINESS INFO -->
        <invoker type="extActions" caption="Issue Permit" action="issuePermit" visibleWhen="#{state =='active'}"/>
    </invokers>
    
    <code>
         <![CDATA[    
        import com.rameses.rcp.annotations.*
        import com.rameses.rcp.common.*
        import com.rameses.osiris2.client.*
        import com.rameses.osiris2.common.*
        import java.rmi.server.*
        import com.rameses.gov.etracs.bpls.business2.*;
        
        class  BusinessInfoController extends BPApplication {
            
            def currentSection;
            def sections;
           
            def _initOpen() {
                sections = InvokerUtil.lookupOpeners( "business:info", [entity: entity ] );
                if(sections.size()>0) currentSection = sections[0];
                windowTitle = entity.appno;
                windowId = entity.objid;
                entity.orgtypename = orgTypes.find{ it.key == entity.orgtype}?.value;
                return super.start("open");
            }
    
            def startOpen() {
                entity = appSvc.open([objid:entity.objid]);
                return _initOpen(); 
            }
             
             //used by barcode
            def startOpenByAppno() {
                entity = appSvc.openByAppno([appno:barcodeid]);
                return _initOpen();
            }
        }
        ]]>
        
    </code>    
        
    <pageflow>
        <start>
            <transition to="#{entity.state}" name="open"/>
        </start>
        
        <page name="info" title="Business Application (For Info)">
            <transition to="end" caption="Close" action="validateClose"/>
            <transition to="assessment" caption="Submit for Assessment"
                confirm="You are about to submit this application for assessment. Proceed?"
                action="submitForAssessment"/>
        </page>    
        
        <page name="assessment" title="Business Application (For Assessment)">
            <transition to="end" caption="Close" action="validateClose"/>
            <transition to="info" caption="Return For Info" 
                confirm="You are about to return this application for info. Proceed?"
                mnemonic="R" action="returnForInfo" role="ASSESSOR"/>
            <transition to="approval" caption="Submit for Approval" 
                confirm="You are about to submit this application for approval. Proceed?"
                name="next" mnemonic="S" action="submitForApproval" role="ASSESSOR"/>
        </page>    
        
        <page name="approval" title="Business Application (For Approval)">
            <transition to="end" caption="Close" action="validateClose"/>
            <transition to="assessment" caption="Return to Assessment" mnemonic="R" action="returnForAssessment" 
                confirm="You are about to return this for assessment. Proceed?" role="APPROVER"/>
            <transition to="payment" caption="Approve" mnemonic="S" action="approve" 
                confirm="You are about to approve this for payment. Proceed?" role="APPROVER"/>
        </page>
        
        <page name="payment" title="Business Application (For Payment)">
            <transition to="end" caption="Close" />
        </page>
        
        <page name="release" title="For Release">
            <transition to="end" caption="Close" />
            <transition to="active" caption="Release" action="release" confirm="You are about to release this application. Proceed?"/>
        </page>
        
        <page name="active" title="Active">
            <transition to="end" caption="Close" />
        </page>
        
        <end/>
    </pageflow>
    
    <pages>
        <page name="info" template="com.rameses.gov.etracs.bpls.business2.BusinessInfoPage"/>
        <page name="assessment" template="com.rameses.gov.etracs.bpls.application.ViewAssessmentPage"/>
        <page name="approval" template="com.rameses.gov.etracs.bpls.application.ViewAssessmentPage"/>
        <page name="payment" template="com.rameses.gov.etracs.bpls.application.ViewAssessmentPage"/>
        <page name="release" template="com.rameses.gov.etracs.bpls.application.ViewAssessmentPage"/>
        <page name="active" template="com.rameses.gov.etracs.bpls.application.ViewAssessmentPage"/>
        <page name="view-info" template="com.rameses.gov.etracs.bpls.application.ApplicationInfoPage"/>
        
        <!-- special page -->
        <page name="update-lob" template="com.rameses.gov.etracs.bpls.application.SpecifyLOBPage"/>
    </pages>
    
</workunit>