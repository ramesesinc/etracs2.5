<workunit>
    <invokers>
        <invoker type="businessledger:addpayment" caption="Payment" 
            target="popup" action="createNew" />
    </invokers>
    <code>
        <![CDATA[    
        import com.rameses.rcp.annotations.*
        import com.rameses.rcp.common.*
        import com.rameses.osiris2.client.*
        import com.rameses.osiris2.common.*
        import java.rmi.server.*
        import com.rameses.gov.etracs.bpls.application.*;
        
        class  AddPaymentReceivableController {
            
            def receivable;
            def entity;
            def handler;

            void createNew() {
                entity = [:];
                entity.objid = "BPRCV"+new UID();
                entity.receivableid = receivable.objid;
                entity.businessid = receivable.businessid;
                entity.iyear = receivable.iyear;
                entity.amtpaid = 0;
                entity.surchargepaid = 0;
                entity.interestpaid = 0;
                entity.discount = 0;
            }
            
            void addAndContinue() {
                if(entity.iyear< 1950 || entity.iyear > 2015)
                    throw new Exception("Year is invalid");
                if( entity.iqtr < 1 || entity.iqtr > 4 )
                    throw new Exception("Qtr is invalid");
                if(entity.amtpaid < 0) 
                    throw new Exception("Amount paid must be greater than 0");                      
                receivable.balance -= entity.amtpaid;    
                handler(entity);
                createNew();
            }
            
            def addAndClose() {
                addAndContinue();
                createNew();
                return "_close";
            }

            def doClose() {
                return "_close";
            }
        }
        ]]>
    </code>
    
    <pages>
        <page template="com.rameses.gov.etracs.bpls.business.AddPayment"/>
    </pages>
    
</workunit>