<workunit extends="wtemplates/gov/treasury/BasicCashReceiptController.xml">
    <invokers>
        <invoker type="cashreceipt:bpls" action="init" />
        <invoker type="cashreceipt:barcode:51005" action="initBarcode" />
    </invokers>
    
    <code>
        <![CDATA[    
        import com.rameses.rcp.annotations.*
        import com.rameses.rcp.common.*
        import com.rameses.osiris2.client.*
        import com.rameses.osiris2.common.*
        import com.rameses.enterprise.treasury.cashreceipt.*
        
        class  BusinessCashReceiptController extends BasicCashReceipt {
            
            @Service("BPBillingService")
            def billSvc;
        
            int startyear = 2013;
            
            def qtrs = [1,2,3,4];
            def years = startyear..1980;
            int year;
            int qtr;
            
            def barcodeid;
            
            void initBarcode() {
                MsgBox.alert( barcodeid );
            }
            
            public void payerChanged( o ) {
                entity.tradename = null;
                entity.appid = null;
                entity.billitems?.clear();
                entity.items.clear();
                entity.amount = 0;
                binding.refresh( "entity.tradename" );
                billingListModel.reload();
                super.clearAllPayments();
                super.updateBalances();
            }
            
            def getLookupBusiness() {
                if(!entity.payer) {
                    return new Exception("Please select a payer first");
                }    
                return InvokerUtil.lookupOpener( "business:lookup", [
                    "query.permiteeid":entity.payer.objid,
                    onselect: { o->
                        entity.tradename = o.tradename;
                        entity.businessid = o.objid;
                        entity.billitems = [];
                        entity.items = [];
                        billingListModel.reload();
                    }
                ]);
            }
            
            void runBilling() {
                def m = [year:year,qtr:qtr,businessid:entity.businessid];
                def result = billSvc.getBillItems( m );
                if(result.billitems.size()==0)
                    throw new Exception("No open items for payment found for the criteria specified" );
                entity.billitems = result.billitems;
                billingListModel.reload();
                entity.items.clear();
                entity.items.addAll( result.receiptitems );
                entity.amount = 0;
                if(entity.items) {
                    entity.amount = entity.items.sum{ it.amount };
                }
                super.updateBalances();
            }
            
            def billingListModel = [
                fetchList: { o->
                    return entity.billitems;
                }
            ] as BasicListModel;
            
        }
        ]]>
        
    </code>
    
    <pages>
        <page template="com.rameses.gov.etracs.bpls.cashreceipt.BPLSCashReceipt"/>
    </pages>
    
</workunit>