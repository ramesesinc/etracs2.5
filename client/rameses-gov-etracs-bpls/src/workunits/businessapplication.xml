<workunit >
    <invokers>
        <invoker type="businessapplication:create" caption="Business" action="create" target="window" index="10" />

        <invoker type="extActions" caption="Info" action="showInfo"/>

    </invokers>
    
    <code>
        <![CDATA[
        import com.rameses.rcp.common.*;
        import com.rameses.rcp.annotations.*;
        import com.rameses.osiris2.client.*;
        import com.rameses.osiris2.common.*
        import java.rmi.server.*;
        
        class BusinessApplication extends PageFlowController {
            
            @Service("BusinessApplicationService")
            def service;
            
            @Service("BusinessAssessmentService")
            def assessmentSvc;

            def orgTypes = LOV.BUSINESS_ORG_TYPES;
            def officeTypes = LOV.BUSINESS_OFFICE_TYPES;
            def entityName = "businessapplication";
            def entity;
            
            def formInfos;
            
            def create() {
                entity = [type:"NEW", lobs:[]];
                entity.objid = "APP"+new UID();
                entity.state = "DRAFT";
                doAssessment();
                return start("initial");
            }
            
            void doAssessment() {
                entity = assessmentSvc.execute(entity);
                buildFormInfos();
            }
            
            def getLookupLOB() {
                return InvokerUtil.lookupOpener("lob:lookup",[
                    onselect: { o->
                        if( entity.lobs.find{ it.lobid ==  o.objid }!=null ) {
                            throw new Exception("LOB Item already added");
                        }    
                        def m = [:];    
                        m.objid = "APPLOB"+new UID();
                        m.lobid = o.objid;
                        m.name = o.name;
                        entity.lobs << m;
                        lobModel.reload();
                    }
                ]);
            }
            
            def lobModel = [
                fetchList: { o->return entity.lobs }
            ] as BasicListModel;
            
            void buildFormInfos() {
                if(formInfos==null) {
                    formInfos = [];
                    entity.infos.each {
                        formInfos << [type:it.type, caption:it.caption, categoryid:it.lobid, name:it.name, bean: it  ];
                    }
                }
            }
            
            def formPanel = [
                getCategory: { lobid->
                    return lobid;  //entity.lobs.find{ it.lobid == lobid }?.name
                },
                updateBean: {name,value,item->
                    println name + "  " + value  + item.bean;
                    item.bean.value = value;
                },
                getControlList: {
                    return formInfos;
                }
            ] as FormPanelModel;
            
            void showInfo() {
                MsgBox.alert( "Hello " + entity );
            }
            
        }
        
        ]]>
    </code>
    
    <pageflow>
        <start>
            <transition to="initial"/>
        </start>
        <page name="initial" title="Business Application(Initial)">
            <transition to="end" caption="Close"/>
            <transition to="addinfo" caption="Next"/>
        </page>    
        <page name="addinfo" title="Business Application(Add Info)">
            <transition to="initial" caption="Back"/>
            <transition to="save" caption="Save"/>
        </page>    
        <end/>
    </pageflow>
    
    <pages>
        <page name="initial1" template="com.rameses.gov.etracs.bpls.application.NewApplicationPage" />
        <page name="initial" template="com.rameses.gov.etracs.bpls.application.AddInfoPage" />
    </pages>
    
    
</workunit>