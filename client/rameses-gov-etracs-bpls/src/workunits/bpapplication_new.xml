<workunit>
    <invokers>
        <invoker folderid="/explorer/txn/bpls/app" caption="New" action="start"/>
        
        
        <invoker type="formActions" caption="Print" action="print" visibleWhen="#{state=='appinfo'}"/>
    </invokers>
    
    <code>
        <![CDATA[    
        import com.rameses.rcp.annotations.*
        import com.rameses.rcp.common.*
        import com.rameses.osiris2.client.*
        import com.rameses.osiris2.common.*
        import com.rameses.gov.etracs.bpls.application.*;
        import com.rameses.gov.etracs.bpls.*;
        
        class NewApplicationController extends BPApplicationController {
        
             @Service("BPAssessmentService")
             def service;
        
             def start() {
                entity.apptype = "NEW";
                entity.infos = [];
                entity.taxfees = [];
                entity.requirements = [];
                return  super.start();
             }
             
             void loadInfos() {
                def result = service.execute(entity);
                if( !result.infos) 
                    throw new Exception("No infos found!");
                    
                //phase 0 is the looping phase.    
                if( result.phase != 0) {
                    entity.infos.addAll(result.infos);
                    entity.requirements.addAll(result.requirements);
                    FormInfo.sortInfos(entity.infos);
                    infoModel.reload();
                    requirementModel.reload();
                }
                else {
                    infos.addAll( result.infos );
                    buildFormInfo();
                }
             }
             
             void updateInfos() {
                entity.infos.addAll(infos);
                infos.clear();
             }
             
             void clearAll() {
                entity.infos.clear();
                entity.requirements.clear();
                entity.taxfees.clear();
             }
             
        }
        ]]>
        
    </code>
    <pageflow>
        <start>
            <transition to="initial"/>
        </start>
        
        <page name="initial" title="New Application">
            <transition to="end" caption="Close"/>
            <transition to="check-infos" caption="Next" />
        </page>
        
        <process name="check-infos" action="loadInfos">
            <transition to="specify-info" cond="#{!!infos}"/>
            <transition to="appinfo" cond="#{!infos}"/>
        </process>
        
        <page name="specify-info" title="Specify Information">
            <transition to="initial" caption="Back" action="clearAll"/>
            <transition to="check-infos" caption="Next" action="updateInfos"/>
        </page>
        
        <page name="appinfo" title="Application Info">
            <transition to="initial" caption="Back" action="clearAll"/>
            <transition to="end" caption="Close"/>
            <transition to="initial" caption="Reset" action="resetInfo"/>
        </page>
        
        
        <end/>
    </pageflow>
    <pages>
        <page name="initial" template="com.rameses.gov.etracs.bpls.application.NewInitialPage"/>
        <page name="appinfo" template="com.rameses.gov.etracs.bpls.application.ApplicationInfoPage"/>
        <page name="specify-info" template="com.rameses.gov.etracs.bpls.application.AddInfoPage"/>
        <page name="info" template="com.rameses.gov.etracs.bpls.application.CompleteInfoPage"/>
    </pages>
    
</workunit>