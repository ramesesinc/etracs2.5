<workunit>
    <invokers>
        <invoker type="bpapplication:create" action="start" target="window" role="BUSINESSINFO,LICENSING"/>
        <invoker type="home.action" caption="New Business Application"  action="start" target="window"  role="BUSINESSINFO,LICENSING"/>
        <invoker type="bpapplication:open" caption="BP Application" action="startOpen" target="window"  role="BUSINESSINFO,LICENSING"/>
        <invoker type="bpapplication:openByAppno" caption="BP Application" action="startOpenByAppno" target="window" role="BUSINESSINFO,LICENSING"/>
        <invoker type="global:barcode:51005" caption="BP Application" action="startOpenByAppno" target="window"  role="BUSINESSINFO,LICENSING"/>
        
        <!-- extended actions -->
        <invoker type="extActions" caption="Print Application" action="printApp" visibleWhen="#{state.matches('success-save|assessment')}"/>
        <invoker type="extActions" caption="Print Assessment" action="printAssessment" visibleWhen="#{state.matches('payment')}"/>
        <invoker type="extActions" caption="Print Billing" action="printBilling" visibleWhen="#{state.matches('payment')}"/>
        
        <invoker type="extActions" caption="Issue BIN" action="issueBin" visibleWhen="#{state.matches('release')}"/>
        <invoker type="extActions" caption="Issue Permit" action="issuePermit" visibleWhen="#{state.matches('release')}"/>
        
        <invoker type="extActions" caption="Edit Info" action="getInfo" visibleWhen="#{state.matches('assessment')}" role="ASSESSOR"/>
        <invoker type="extActions" caption="Save"  action="save" visibleWhen="#{state.matches('assessment')}" role="ASSESSOR"/>
        
        <!--
        <invoker type="extActions" caption="Reports" name="popupReports"   
            visibleWhen="#{state.matches('approval|view-info')}" category="bpapplication:payment:reports" />
        -->    
    </invokers>
    
    <code>
        <![CDATA[    
        import com.rameses.rcp.annotations.*
        import com.rameses.rcp.common.*
        import com.rameses.osiris2.client.*
        import com.rameses.osiris2.common.*
        import java.rmi.server.*;
        import com.rameses.gov.etracs.bpls.application.*;
        
        class BPApplicationController extends BPApplicationExtended {
        
             @Service("BusinessNameVerificationService")
             def nameSvc;
             
             @FormTitle
             String windowTitle;
        
             @FormId
             def windowId;
             
             def searchNamePass = true;
             def message;
             def barcodeid;
             
             def start() {
                initNew();
                windowTitle = "New BP Application";
                windowId = entity.objid;
                return  super.start("create");
             }
             
             def startOpen() {
                entity = appSvc.open([objid:entity.objid]);
                if(entity.state=="approval") {
                    def result = appSvc.assess(entity);
                    entity.taxfees = result.taxfees;
                }
                windowTitle = entity.appno;
                windowId = entity.objid;
                updateBalances();
                entity.orgtypename = orgTypes.find{ it.key == entity.orgtype}?.value;
                return  super.start("open");
             }
             
             def startOpenByAppno() {
                entity = appSvc.openByAppno([appno:barcodeid]);
                if(entity.state=="approval") {
                    def result = appSvc.assess(entity);
                    entity.taxfees = result.taxfees;
                }
                windowTitle = entity.appno;
                windowId = entity.objid;
                updateBalances();
                entity.orgtypename = orgTypes.find{ it.key == entity.orgtype}?.value;
                return  super.start("open");
             }
             
             void checkBusinessName() {
                 searchList  = nameSvc.getList(entity.tradename); 
                 if(searchList) {
                    searchNamePass = false;
                    searchListModel.reload();
                 }
                 else {
                    searchNamePass = true;
                 }
             }

             String getMessage() {
                if( state == "confirm-save" )
                    return "Please check that all entries are valid. Click Submit when completed.";
                else
                    return null;
             }
             
             void createApplication() {
                entity = appSvc.create( entity );
             }
             
             void save() {
                appSvc.update( entity );
             }

             def printApp() {
                return InvokerUtil.lookupOpener( "bpapplication:application:report", [entity: entity] );
             }
             
             def printAssessment() {
                return InvokerUtil.lookupOpener( "bpapplication:assessment:report", [entity: entity] );
             }
             
             def printBilling() {
                return InvokerUtil.lookupOpener( "bpapplication:billing:report", [entity: entity] );
             }
             
             void submitForApproval() {
                appSvc.submitForApproval(entity);
             }
             
             void submitForPayment() {
                appSvc.submitForPayment(entity);
             }
             
             void sendBackToAssessment() {
                appSvc.sendBackToAssessment(entity);
             }
             
             void notSupported() {
                throw new Exception("Feature not yet supported");
             }
             
             void validateRequirements() {
                //check step 
                appSvc.validateRequirements( entity.requirements, "info" );  
             }
             
             void issueBin() {
                if(MsgBox.confirm("You are about to issue BIN for this business. Proceed?")) {
                    def b = appSvc.issueBin( entity );
                    MsgBox.alert("Assigned BIN No. " + b.bin );
                    entity.bin = b.bin;
                    binding.refresh("entity.bin");
                }
             }
             
             void issuePermit() {
                if(MsgBox.confirm("You are about to issue BIN for this business. Proceed?")) {
                    def b = appSvc.issuePermit( entity );
                    entity.permit = b.permit;
                }
             }
             
        }
        ]]>
        
    </code>
    <pageflow>
        <start>
            <transition to="initial" name="create"/>
            <transition to="#{entity.state}" name="open"/>
        </start>
        
        <page name="initial" title="Select Type of Application">
            <transition to="end" caption="Close"  confirm="Data will not be saved. Proceed?"/>
            <transition to="select-type" caption="Next" mnemonic="N"  immediate="false"/>
        </page>

        <process name="select-type">
            <transition name="t1" to="specify-tradename" cond="#{entity.apptype=='NEW'}"/>
            <transition name="t2" to="specify-tradename" cond="#{entity.apptype=='RENEW' &amp;&amp; entity.txnmode == 'CAPTURE'}"/>
            <transition to="select-renewal" cond="#{entity.apptype=='RENEW' &amp;&amp; entity.txnmode=='ONLINE'}"/>
            <transition name="t3" to="initial" action="notSupported"/>
        </process>

        <page name="specify-tradename" title="Specify Trade Name">
            <transition to="end" caption="Close"  confirm="Data will not be saved. Proceed?"/>
            <transition to="check-business-name" caption="Next" mnemonic="N" immediate="false"/>
        </page>
        
        <process name="check-business-name" action="checkBusinessName">
            <transition to="verify-business-name" cond="#{searchNamePass==false}"/>
            <transition to="specify-lob" cond="#{searchNamePass==true}"/>
        </process>
            
        <page name="verify-business-name" title="Business Name Verification">
            <transition to="end" caption="Close" confirm="Data will not be saved. Proceed?"/>
            <transition to="specify-tradename" caption="Back" mnemonic="B"/>
            <transition to="specify-lob" caption="Next" mnemonic="N"/>
        </page>

        <page name="specify-lob" title="Specify Lines of Business">
            <transition to="end" caption="Close" confirm="Data will not be saved. Proceed?"/>
            <transition to="specify-tradename" caption="Back" mnemonic="B"/>
            <transition to="specify-info" caption="Next" mnemonic="N" action="validateLOB"/>
        </page>
        
        <page name="specify-info" title="Specify Business Information">
            <transition to="end" caption="Close" confirm="Data will not be saved. Proceed?"/>
            <transition to="specify-lob" caption="Back" mnemonic="B"/>
            <transition to="specify-requirement" caption="Next" mnemonic="N" action="validateInfo"/>
        </page>
        
        <page name="specify-requirement" title="Specify Requirements">
            <transition to="end" caption="Close" confirm="Data will not be saved. Proceed?"/>
            <transition to="specify-info" caption="Back" mnemonic="B"/>
            <transition to="confirm-save" caption="Next" mnemonic="N" action="validateRequirements"/>
        </page>
        
        <page name="confirm-save" title="Confirm Business Application">
            <transition to="end" caption="Close" confirm="Data will not be saved. Proceed?"/>
            <transition to="specify-requirement" caption="Back" mnemonic="B"/>
            <transition to="success-save" caption="Submit" mnemonic="S" immediate="false" 
                confirm="You are about to submit this application. Proceed?"
                action="createApplication"/>
        </page>    

        <page name="success-save" title="Business Application">
            <transition to="end" caption="Close"/>
            <transition to="initial" caption="Add Another" action="initNew"/>
        </page>    
        
        <page name="assessment" title="Business Application">
            <transition to="end" caption="Close"/>
            <transition to="view-assessment" caption="Assess" mnemonic="S" immediate="false" action="assess" role="ASSESSOR"/>
            <transition to="change-lob" caption="Change Line of Business" immediate="false" role="ASSESSOR"/>
        </page>    
        
        <page name="change-lob" title="Change Lines of Business">
            <transition to="assessment" caption="Back" />
        </page>
        
        <page name="view-assessment" title="Assessment">
            <transition to="assessment" caption="Back"/>
            <transition to="view-info" caption="Submit for Approval" mnemonic="A" action="submitForApproval"
                immediate="false" confirm="You are about to submit this for approval. Proceed?"/>
        </page>    

        <page name="view-info" title="Business Application">
            <transition to="end" caption="Close" />
        </page>
        
        <page name="approval" title="For Approval">
            <transition to="end" caption="Close" />
            <transition to="view-info" caption="Return to Assessment" mnemonic="R" action="sendBackToAssessment" 
                immediate="false" confirm="You are about to return this for assessment. Proceed?" role="APPROVER"/>
            <transition to="payment" caption="Submit for Payment" mnemonic="S" action="submitForPayment" 
                immediate="false" confirm="You are about to submit this for payment. Proceed?" role="APPROVER"/>
        </page>
        
        
        <page name="payment" title="For Payment">
            <transition to="end" caption="Close" />
        </page>
        
        <page name="release" title="For Release">
            <transition to="end" caption="Close" />
        </page>
        
        
        <end/>
    </pageflow>
    <pages>
        <page name="initial" template="com.rameses.gov.etracs.bpls.application.SelectApplicationType"/>
        <page name="specify-tradename" template="com.rameses.gov.etracs.bpls.application.SpecifyTradename"/>
        <page name="verify-business-name" template="com.rameses.gov.etracs.bpls.application.VerifyBusinessName"/>

        <page name="specify-lob" template="com.rameses.gov.etracs.bpls.application.SpecifyLOB"/>
        <page name="change-lob" template="com.rameses.gov.etracs.bpls.application.SpecifyLOB"/>
        <page name="specify-info" template="com.rameses.gov.etracs.bpls.application.SpecifyInfo"/>
        <page name="specify-requirement" template="com.rameses.gov.etracs.bpls.application.SpecifyRequirement"/>
        <page name="confirm-save" template="com.rameses.gov.etracs.bpls.application.ApplicationInfoPage"/>
        <page name="success-save" template="com.rameses.gov.etracs.bpls.application.SuccessPage"/>
        <page name="view-assessment" template="com.rameses.gov.etracs.bpls.application.ViewAssessmentPage"/>
        
        <page name="draft" template="com.rameses.gov.etracs.bpls.application.ApplicationInfoPage"/>
        <page name="assessment" template="com.rameses.gov.etracs.bpls.application.ApplicationInfoPage"/>
        <page name="payment" template="com.rameses.gov.etracs.bpls.application.ApplicationInfoPage"/>
        <page name="approval" template="com.rameses.gov.etracs.bpls.application.ApplicationInfoPage"/>
        <page name="release" template="com.rameses.gov.etracs.bpls.application.ApplicationInfoPage"/>
        <page name="view-info" template="com.rameses.gov.etracs.bpls.application.ApplicationInfoPage"/>

    </pages>
    
</workunit>