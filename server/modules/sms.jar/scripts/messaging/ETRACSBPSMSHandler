
import com.rameses.annotations.*;
import java.util.concurrent.*;
import com.rameses.osiris3.server.JsonUtil;

class ETRACSBPSMSHandler
{
	@Service("SMSSendService")
	def smsSvc;
	
	@OnMessage(value="sms", eval="data.msg.startsWith('BP')")
	public void handle(def params) 
	{
		println "BPSMSHandler -> " + params;
		
		def tokens = params.msg.tokenize(' ');
		def reply = [
			retcode		: 'OK', 
			msg 		: 'test only',
			to 			: params.from,
			acctname 	: "etracssms",
			apikey		: "etracssms1234",
		];

		
		if( tokens.size() < 2) {
			reply.retcode = 'ERROR'
			reply.msg = 'Application No. is required.';
		}
		else {
			try{
				def httpc = new com.rameses.httpclient.HttpClient("192.168.56.1:8080/municipality");
		        def result = httpc.post("BPSmsInquiryService/askBillByAppno.json", [appno:tokens[1]]);
		        reply.putAll( JsonUtil.toMap(result))
			}
			catch( Throwable e ) {
				reply.retcode = 'ERROR'
				reply.msg = e.message;
			}
		}
		smsSvc.send(reply)
		
	} 
}
