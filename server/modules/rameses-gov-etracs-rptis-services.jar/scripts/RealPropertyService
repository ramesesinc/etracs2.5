import com.rameses.annotations.*
import com.rameses.common.*
import com.rameses.services.extended.*

class RealPropertyService 
{
	@ActiveDB('realproperty')
	def em

	@Service('LGUService')
	def lguSvc

	@Service('RPTUtil')
	def util

	@Service('Var')
	def var 

	@Service('WorkflowStateService')
	def workflowSvc 

	def STATE_INTERIM       = 'INTERIM'
    def STATE_FORAPPROVAL   = 'FORAPPROVAL'
    def STATE_CURRENT       = 'CURRENT'
    def STATE_CANCELLED     = 'CANCELLED'

    def SECTION_NEW_MAX  	= 3
	def PARCEL_NEW_MAX  	= 2
	def SECTION_OLD_MAX  	= 2
	def PARCEL_OLD_MAX  	= 3


	@ProxyMethod
	public def init(  ) {
		def objid = util.generateId('RP')
		return [
			objid		: objid,
			state 		: 'INTERIM',
			lgutype 	: var.lgu_type,
			ry 			: var.current_ry,
			autonumber	: false,
		]	
	}

	@ProxyMethod
	public def create( entity ) {
		entity.barangayid = entity.barangay?.objid
		entity.state = STATE_INTERIM
		validateSectionParcelLength(entity)
		em.create(entity)	
		return entity;
	}

	@ProxyMethod
	public def update( entity ) {
		entity.barangayid = entity.barangay?.objid
		validateSectionParcelLength(entity)
		em.update(entity)	
		return entity;
	}

	@ProxyMethod
	public def open( entity ) {
		entity = em.read(entity)	
		entity.autonumber = util.toBoolean(entity.autonumber, false)
		entity.barangay = lguSvc.lookupBarangayById(entity.barangayid)

		entity.munidistrict = lguSvc.lookupDistrictById(entity.barangay.parentid)
		if (!entity.munidistrict) 
			entity.munidistrict = lguSvc.lookupMunicipalityById(entity.barangay.parentid)

		entity.provcity = lguSvc.lookupCityById(entity.munidistrict.parentid)
		if (!entity.provcity)
			entity.provcity = lguSvc.lookupProvinceById(entity.munidistrict.parentid) 

		return entity 
	}

	@ProxyMethod
	public void removeEntity( entity ) {
		workflowSvc.delete(entity)
		em.delete(entity)	
	}

	@ProxyMethod
	public def approve( entity ) {
		entity.state = STATE_CURRENT
		def retval = em.approve(entity)	
		if (retval == 0) throw new Exception('Real Property has already been cancelled.')
		return entity
	}


	@ProxyMethod
	public def disapprove( entity ) {
		entity.state = STATE_INTERIM
		def retval = em.disapprove(entity)	
		return entity
	}
	
	@ProxyMethod
    public def getRyList(  ) {
        return em.getLandRevisionYears().ry;
    }


    @ProxyMethod
    public def validateRealPropertyForFaas(rp, faasid){
    	if (rp.state == STATE_CANCELLED)
    		throw new Exception('Real Property has already been cancelled.')

    	def faas = em.findFaasByRealPropertyId([realpropertyid:rp.objid, faasid:faasid])
    	if (faas)
    		throw new Exception('Real Property is currently referenced by TD No. ' + faas.tdno + '.')
    }


	void validateSectionParcelLength(entity){
		if (entity.pintype == 'new' && entity.section.length() > 3) 
			throw new Exception('Invalid section. Section must be less than or equal to 999.')
        if (entity.pintype == 'old' && entity.section.length() > 2) 
        	throw new Exception('Invalid section. Section must be less than or equal to 99.')

        if (entity.pintype == 'new' && entity.parcel.length() > 2) 
        	throw new Exception('Invalid parcel. Parcel must be less than or equal to 99.')
        if (entity.pintype == 'old' && entity.parcel.length() > 3) 
        	throw new Exception('Invalid parcel. Parcel must be less than or equal to 999.')
	}
 

}
