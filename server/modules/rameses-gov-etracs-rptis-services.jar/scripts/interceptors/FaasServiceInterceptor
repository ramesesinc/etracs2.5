import com.rameses.annotations.*
import com.rameses.eserver.*;
import com.rameses.common.*;

class FaasServiceInterceptor
{

	@Service('RPUService')
	def rpuSvc 

	@Service('RPTLedgerService')
	def ledgerSvc

	@Service('RPTUtil')
	def util

	@Service('Var')
	def var

	@Service('LogService')
	def logSvc 


	@After(pattern="FAASService.createFaas.*") 
	public void logCreate( evt ) {
		def faas = evt.result 
		logSvc.log( 'create', 'FAAS', faas.objid)
	}

	@After(pattern="FAASService.updateFaas.*") 
	public void logUpdate( evt ) {
		def faas = evt.result 
		logSvc.log( 'update', 'FAAS', faas.objid)
	}

	@After(pattern="FAASService.submitFaasForApproval") 
	public void logSubmitFaasForApproval( evt ) {
		def faas = evt.result 
		logSvc.log( 'submitFaasForApproval', 'FAAS', faas.objid)
	}

	@After(pattern="FAASService.approveFaas") 
	public void logApproveFaas( evt ) {
		def faas = evt.result 
		logSvc.log( 'approveFaas', 'FAAS', faas.objid)
	}

	@After(pattern="FAASService.disapproveFaas") 
	public void logDisapproveFaas( evt ) {
		def faas = evt.result 
		logSvc.log( 'disapproveFaas', 'FAAS', faas.objid)
	}

	@After(pattern="FAASService.submitFaasToProvince") 
	public void logSubmitFaasToProvince( evt ) {
		def faas = evt.result 
		logSvc.log( 'submitFaasToProvince', 'FAAS', faas.objid)
	}

	@After(pattern="FAASService.approveFaasSubmissionToProvince") 
	public void logApproveFaasSubmissionToProvince( evt ) {
		def faas = evt.result 
		logSvc.log( 'approveFaasSubmissionToProvince', 'FAAS', faas.objid)
	}

	@After(pattern="FAASService.disapproveFaasSubmissionToProvince") 
	public void logDisapproveFaasSubmissionToProvince( evt ) {
		def faas = evt.result 
		logSvc.log( 'disapproveFaasSubmissionToProvince', 'FAAS', faas.objid)
	}

	@After(pattern="FAASService.approveFaasByProvince") 
	public void logApproveFaasByProvince( evt ) {
		def faas = evt.result 
		logSvc.log( 'approveFaasByProvince', 'FAAS', faas.objid)
	}

	@After(pattern="FAASService.disapproveFaasByProvince") 
	public void logDisapproveFaasByProvince( evt ) {
		def faas = evt.result 
		logSvc.log( 'disapproveFaasByProvince', 'FAAS', faas.objid)
	}






	@Before(pattern="FAASService.initTransaction")  
	public void interceptInitFaasTransaction( evt ) {
		def info = evt.args[0]
		ledgerSvc.checkLedgerApprovedState(info.faas.objid)
		if (info.txntype.objid != 'GR') {
			if ( util.toBoolean(var.allow_faas_transaction_with_balance, false) == false ){
				ledgerSvc.checkLedgerBalance(info.faas.objid)
			}
		}
	}

	@After(pattern="FAASService.initTransaction", eval="#{result.txntype.objid == 'TR'}", index=10) 
	public void initSimpleTransfer( evt ) {
		def faas = evt.result 
		clearInfo(faas)
		
	}

	@After(pattern="FAASService.initTransaction", eval="#{result.txntype.objid == 'TRE'}", index=10) 
	public void initTransferWithReassessment( evt ) {
		def faas = evt.result 
		clearInfo(faas)
	}

	@After(pattern="FAASService.initTransaction", eval="#{result.txntype.objid == 'TRC'}", index=10) 
	public void initTransferWithCorrection( evt ) {
		def faas = evt.result 
		clearInfo(faas)
	}

	@After(pattern="FAASService.initTransaction", eval="#{result.txntype.objid == 'CD'}", index=10) 
	public void initChangeDepreciation( evt ) {
		def faas = evt.result 
		if (faas.rpu.rputype == 'land') {
			throw new Exception('Cannot depreciate Land property.')
		}
	}

	@After(pattern="FAASService.initCapture", eval="#{result.txntype.objid == 'ND'}", index=10) 
	public void initNewDiscovery( evt ) {
		def faas = evt.result 
		faas.autonumber = util.toBoolean(var.td_autonumber, false)
	}

	@After(pattern="FAASService.initTransaction", eval="#{result.txntype.objid == 'MC'}", index=10) 
	public void initMultipleClaim( evt ) {
		def info = evt.args[0]
		def faas = evt.result 
		faas.rp.claimno = info.claimno 
		faas.rpu.fullpin += ' (' + info.claimno + ')'
		faas.prevtdno = null
		faas.prevpin = null
		faas.prevowner = null
		faas.prevav = 0.0
		faas.prevmv = 0.0
		faas.rpu.previd = null
		faas.rp.previd = null
		clearInfo(faas)
	}


	/*---------------------------------------------------
	*
	* Clear info related to transfer
	*
	*--------------------------------------------------*/	
	void clearInfo(faas){
		faas.tdno 					= null
		faas.titletype				= null
		faas.titleno				= null
		faas.titledate				= null
		faas.taxpayer				= [:]
		faas.owner					= [:]
		faas.administrator 			= [:]
		faas.beneficiary 			= [:]
		faas.memoranda				= null
	}
}

