import com.rameses.annotations.*;
import com.rameses.util.*;
import java.rmi.server.*;
import com.rameses.services.extended.*

public class BPApplicationLookupService extends ActiveCrudListService {

	@ActiveDB("bpapplication")
	def em;

	@ActiveDB("collectiontype")
	def collectionType;
	
	String listMethod = "getLookup";

	public def getColumns(def o) {
		return [
			[name:"appno", caption:"Application No"],
			[name:"apptype", caption:"Application Type"],
			[name:"businessname", caption:"Business Name"],
			[name:"owner.name", caption:"Owner"],
			[name:"bin", caption:"BIN"],
		];
	}

	public void beforeList(o) {
		if( o.ownerid && o.state!=null &&  o.state.equalsIgnoreCase("payment") ) {
			o._listMethod = "getApplicationsByOwner";
			o._pagingKeys = "ba.objid";
		}
	}

	@ProxyMethod
	public def findByBarcode(o) {
		def prefix = o.prefix;
		def appno = o.barcode;
		def m = em.findApplicationByAppNo( [appno: appno] );
		if(!m)
			throw new Exception("Application No " + o + " does not exist!");
		m.collectiontype = collectionType.findCollectionTypeByBarcode([barcode: prefix]);
		if(!m.collectiontype)	
			throw new Exception("Collection type not found with barcode prefix " + prefix + ". Please check collection type and register barcode prefix");
		return m;
	}

}
