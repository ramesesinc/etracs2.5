import com.rameses.annotations.*;
import com.rameses.util.*;
import java.rmi.server.*;
import com.rameses.services.extended.*

public class BPApplicationLookupService extends ActiveCrudListService {

	@ActiveDB("bpapplication")
	def em;

	@ActiveDB("collectiontype")
	def collectionType;
	
	String listMethod = "getLookup";

	public def getColumns(def o) {
		return [
			[name:"appno", caption:"Application No"],
			[name:"tradename", caption:"Tradename"],
			[name:"owner.name", caption:"Owner"],
			[name:"bin", caption:"BIN"],
		];
	}

	public void beforeList(o) {
		if( o.state!=null &&  o.state.toUpperCase() == "PAYMENT" ) {
			o._listMethod = "getLookupByOwner";
			o._pagingKeys = "ba.objid";
		}
	}

	@ProxyMethod
	public def findByBarcode(o) {
		def prefix = o.prefix;
		def appno = o.barcode;

		def m = em.findApplicationByAppNo( [appno: appno] );
		m.collectiontype = collectionType.findCollectionTypeByBarcode([barcode: prefix]);

		if(!m)
			throw new Exception("Application No " + o + " does not exist!");
		return m;
	}

}
